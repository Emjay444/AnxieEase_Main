{
  "rules": {
    "devices": {
      "AnxieEase001": {
        ".read": true,
        ".write": false,
        
        "assignment": {
          ".read": "auth != null",
          ".write": "auth != null && (auth.token.admin == true || !data.exists())"
        },
        
        "metadata": {
          ".read": true,
          ".write": true,
          ".validate": "newData.hasChildren(['deviceType', 'status']) && newData.child('deviceType').isString() && newData.child('status').isString()",
          ".indexOn": ["status", "deviceType", "isSimulated"]
        },
        
        "current": {
          ".read": true,
          ".write": true,
          ".validate": "newData.hasChildren() && newData.child('timestamp').isNumber()",
          ".indexOn": ["timestamp", "severityLevel", "connectionStatus"]
        },
        
        "history": {
          "$timestamp": {
            ".read": true,
            ".write": true,
            ".validate": "newData.hasChildren() && newData.child('timestamp').isNumber()",
            ".indexOn": ["timestamp", "sessionId"]
          }
        },
        
        "alerts": {
          "$timestamp": {
            ".read": true,
            ".write": true,
            ".validate": "newData.hasChildren(['type', 'severity', 'timestamp']) && newData.child('timestamp').isNumber()",
            ".indexOn": ["timestamp", "type", "severity"]
          }
        }
      },
      
      "$deviceId": {
        ".read": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || root.child('device_ownership').child($deviceId).child('sharedWith').child(auth.uid).exists())",
        ".write": false,
        
        "metadata": {
          ".read": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || !root.child('device_ownership').child($deviceId).exists())",
          ".write": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || !root.child('device_ownership').child($deviceId).exists())",
          ".validate": "newData.hasChildren(['deviceType', 'status']) && newData.child('deviceType').isString() && newData.child('status').isString()",
          ".indexOn": ["status", "deviceType", "isSimulated"]
        },
        
        "current": {
          ".read": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || root.child('device_ownership').child($deviceId).child('sharedWith').child(auth.uid).exists() || !root.child('device_ownership').child($deviceId).exists())",
          ".write": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || !root.child('device_ownership').child($deviceId).exists())",
          ".validate": "newData.hasChildren() && newData.child('timestamp').isNumber()",
          ".indexOn": ["timestamp", "severityLevel", "connectionStatus"]
        },
        
        "history": {
          "$timestamp": {
            ".read": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || !root.child('device_ownership').child($deviceId).exists())",
            ".write": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || !root.child('device_ownership').child($deviceId).exists())",
            ".validate": "newData.hasChildren() && newData.child('timestamp').isNumber()",
            ".indexOn": ["timestamp", "sessionId"]
          }
        },
        
        "alerts": {
          "$timestamp": {
            ".read": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || !root.child('device_ownership').child($deviceId).exists())",
            ".write": "auth != null && (root.child('device_ownership').child($deviceId).child('userId').val() == auth.uid || !root.child('device_ownership').child($deviceId).exists())",
            ".validate": "newData.hasChildren(['type', 'severity', 'timestamp']) && newData.child('timestamp').isNumber()",
            ".indexOn": ["timestamp", "type", "severity"]
          }
        }
      }
    },
    
    "users": {
      "$userId": {
        ".read": "auth != null && (auth.uid == $userId || auth.token.admin == true)",
        ".write": "auth != null && (auth.uid == $userId || auth.token.admin == true)",
        
        "profile": {
          ".validate": "newData.hasChildren(['name']) && newData.child('name').isString()"
        },
        
        "sessions": {
          "$sessionId": {
            "metadata": {
              ".validate": "newData.hasChildren(['deviceId', 'startTime']) && newData.child('deviceId').isString() && newData.child('startTime').isNumber()"
            },
            "current": {
              ".validate": "newData.hasChildren(['heartRate', 'timestamp']) && newData.child('heartRate').isNumber() && newData.child('timestamp').isNumber()"
            },
            "history": {
              "$timestamp": {
                ".validate": "newData.hasChildren(['heartRate', 'timestamp']) && newData.child('heartRate').isNumber() && newData.child('timestamp').isNumber()"
              }
            }
          }
        },
        
        "baseline": {
          ".validate": "newData.hasChildren(['baselineHR']) && newData.child('baselineHR').isNumber()"
        },
        
        "lastActivity": {
          ".validate": "newData.isNumber()"
        },
        
        "deviceId": {
          ".validate": "newData.isString()"
        }
      }
    },
    
    "device_ownership": {
      "$deviceId": {
        ".read": "auth != null && (data.child('userId').val() == auth.uid || data.child('sharedWith').child(auth.uid).exists())",
        ".write": "auth != null && (!data.exists() || data.child('userId').val() == auth.uid)",
        ".validate": "newData.hasChildren(['userId', 'deviceType']) && newData.child('userId').isString() && newData.child('deviceType').isString()"
      }
    },
    
    "user_profiles": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null && auth.uid == $userId",
        ".validate": "newData.isString() || (newData.hasChildren() && !newData.hasChild('private_key'))"
      }
    },
    
    "system": {
      "errors": {
        ".read": "auth != null && auth.token.admin == true",
        ".write": "auth != null"
      },
      "stats": {
        ".read": "auth != null && auth.token.admin == true",
        ".write": "auth != null"
      }
    },
    
    "system_config": {
      ".read": "auth != null",
      ".write": "false"
    },
    
    "emergency_access": {
      "$requestId": {
        ".read": "auth != null",
        ".write": "auth != null && (!data.exists() || data.child('requestedBy').val() == auth.uid)",
        ".validate": "newData.hasChildren(['userId', 'requestedBy', 'reason', 'timestamp']) && newData.child('timestamp').isNumber()"
      }
    }
  }
}
